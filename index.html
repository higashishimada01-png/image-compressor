import React, { useState, useEffect, useRef } from 'react';
import { 
  Upload, Download, Image as ImageIcon, X, 
  Settings, ShieldCheck, Zap, Smartphone, 
  Check, ArrowRight, User, FileText, Lock, 
  Smile, Sparkles, Shield, Server
} from 'lucide-react';

// --- UI Components ---
const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
  const baseStyle = "font-bold rounded-2xl transition-all duration-300 active:scale-95 flex items-center justify-center gap-2 px-8 py-4 shadow-sm";
  const variants = {
    primary: "bg-blue-600 hover:bg-blue-700 text-white shadow-blue-100 hover:shadow-xl hover:shadow-blue-200",
    secondary: "bg-white border border-gray-200 hover:border-blue-400 text-gray-700 hover:text-blue-600 hover:shadow-lg",
    danger: "text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full p-2 w-10 h-10 flex items-center justify-center",
  };
  
  return (
    <button 
      onClick={onClick} 
      className={`${baseStyle} ${variants[variant]} ${className}`}
      {...props}
    >
      {children}
    </button>
  );
};

// --- Page Content Components ---
const OperatorInfo = () => (
  <div className="max-w-3xl mx-auto py-10">
    <div className="bg-white p-10 md:p-16 rounded-[3rem] shadow-xl border border-gray-100">
      <div className="flex items-center gap-4 mb-8 border-b pb-6">
        <User size={32} className="text-blue-600" />
        <h2 className="text-3xl font-black text-gray-900">運営者情報</h2>
      </div>
      <div className="space-y-8 text-gray-700 text-lg leading-loose">
        <p className="whitespace-pre-wrap bg-gray-50 p-6 rounded-2xl border-l-4 border-blue-600">
          昭和？年生まれ{"\n"}
          画像圧縮ツールがあったらいいなという思いつきから制作しました。{"\n"}
          サーバーにデータを送らない、安心・安全な設計です。
        </p>
        <div className="p-8 bg-gray-900 rounded-3xl text-white">
          <p className="text-blue-400 text-sm font-bold mb-2">お問い合わせ</p>
          <p className="font-mono break-all">dongshantian674@gmail.com</p>
        </div>
      </div>
    </div>
  </div>
);

const PrivacyPolicy = () => (
  <div className="max-w-3xl mx-auto py-10">
    <div className="bg-white p-10 md:p-16 rounded-[3rem] shadow-sm border border-gray-100">
      <div className="flex items-center gap-4 mb-8 border-b pb-6">
        <Lock size={32} className="text-green-600" />
        <h2 className="text-3xl font-black text-gray-900">プライバシーポリシー</h2>
      </div>
      <div className="text-gray-600 space-y-6">
        <p>当サイトは、ブラウザ側で画像処理を行うため、お客様の画像データをサーバーに送信することはありません。</p>
        <p>アクセス解析にはGoogleアナリティクスを使用しています。データは匿名で収集されます。</p>
      </div>
    </div>
  </div>
);

const Terms = () => (
  <div className="max-w-3xl mx-auto py-10">
    <div className="bg-white p-10 md:p-16 rounded-[3rem] shadow-sm border border-gray-100">
      <div className="flex items-center gap-4 mb-8 border-b pb-6">
        <FileText size={32} className="text-purple-600" />
        <h2 className="text-3xl font-black text-gray-900">利用規約</h2>
      </div>
      <div className="text-gray-600 space-y-6">
        <p>1. 本規約は、当サイトの利用条件を定めるものです。</p>
        <p>2. 当サイトの利用により生じた損害について、運営者は一切の責任を負いません。</p>
        <p>3. 予告なくサービス内容を変更することがあります。</p>
      </div>
    </div>
  </div>
);

// --- Main Application ---
export default function App() {
  const [currentPage, setCurrentPage] = useState('home');
  const [files, setFiles] = useState([]);
  const [quality, setQuality] = useState(0.8);
  const [isProcessing, setIsProcessing] = useState(false);
  const [dragActive, setDragActive] = useState(false);
  const fileInputRef = useRef(null);

  useEffect(() => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [currentPage]);

  const compressImage = async (file, currentQuality) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (event) => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const format = 'image/jpeg';
          const compressedDataUrl = canvas.toDataURL(format, currentQuality);
          const size = Math.round((compressedDataUrl.length - 22) * 3 / 4);
          resolve({
            id: Math.random().toString(36).substr(2, 9),
            originalFile: file,
            compressedPreview: compressedDataUrl,
            originalSize: file.size,
            compressedSize: size,
            fileName: file.name,
          });
        };
      };
    });
  };

  const handleFiles = async (fileList) => {
    setIsProcessing(true);
    const validFiles = Array.from(fileList).filter(file => file.type.startsWith('image/'));
    const processed = await Promise.all(validFiles.map(file => compressImage(file, quality)));
    setFiles(prev => [...processed, ...prev]);
    setIsProcessing(false);
  };

  useEffect(() => {
    if (files.length === 0) return;
    const timer = setTimeout(async () => {
      setIsProcessing(true);
      const reCompressed = await Promise.all(files.map(f => compressImage(f.originalFile, quality)));
      setFiles(reCompressed);
      setIsProcessing(false);
    }, 500);
    return () => clearTimeout(timer);
  }, [quality]);

  const onDragOver = (e) => { e.preventDefault(); setDragActive(true); };
  const onDrop = (e) => {
    e.preventDefault(); setDragActive(false);
    if (e.dataTransfer.files) handleFiles(e.dataTransfer.files);
  };

  const formatSize = (bytes) => {
    if (bytes === 0) return '0 B';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
  };

  const HomeView = () => (
    <div className="space-y-16 py-8">
      {/* Hero */}
      <section className="text-center">
        <div className="inline-flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-full text-sm font-bold mb-6">
          <Shield size={16} /> <span>100% 安全・ブラウザ完結型</span>
        </div>
        <h1 className="text-4xl md:text-6xl font-black text-gray-900 mb-6 leading-tight">
          画像を<span className="text-blue-600">ギュッ</span>と軽くする。
        </h1>
        <p className="text-gray-500 text-lg max-w-xl mx-auto mb-10">
          サーバーに一切送信しないから安心。一瞬で画像を最適化します。
        </p>

        {/* Dropzone */}
        <div 
          onDragOver={onDragOver}
          onDragLeave={() => setDragActive(false)}
          onDrop={onDrop}
          onClick={() => fileInputRef.current.click()}
          className={`max-w-2xl mx-auto border-4 border-dashed rounded-[2.5rem] p-12 md:p-20 transition-all cursor-pointer bg-white ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'}`}
        >
          <input ref={fileInputRef} type="file" multiple accept="image/*" className="hidden" onChange={(e) => handleFiles(e.target.files)} />
          <Upload size={48} className="mx-auto mb-6 text-blue-500" />
          <p className="text-xl font-bold text-gray-800">画像をここにドロップ</p>
          <p className="text-gray-400">またはクリックして選択</p>
        </div>
      </section>

      {/* Results */}
      {files.length > 0 && (
        <div className="space-y-6 max-w-3xl mx-auto">
          <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
            <div className="flex justify-between items-center mb-4">
              <span className="font-bold text-gray-700">圧縮クオリティ: {Math.round(quality * 100)}%</span>
            </div>
            <input type="range" min="0.1" max="1.0" step="0.05" value={quality} onChange={(e) => setQuality(parseFloat(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
          </div>

          {files.map(file => (
            <div key={file.id} className="bg-white p-4 rounded-3xl border border-gray-100 flex flex-col sm:flex-row items-center gap-6">
              <img src={file.compressedPreview} className="w-20 h-20 object-cover rounded-2xl" />
              <div className="flex-1 min-w-0">
                <p className="font-bold text-gray-900 truncate">{file.fileName}</p>
                <p className="text-sm text-gray-400">{formatSize(file.originalSize)} → <span className="text-blue-600 font-bold">{formatSize(file.compressedSize)}</span></p>
              </div>
              <div className="flex items-center gap-2">
                <Button onClick={() => {
                  const a = document.createElement('a'); a.href = file.compressedPreview; a.download = `min_${file.fileName}`; a.click();
                }}>ダウンロード</Button>
                <Button variant="danger" onClick={() => setFiles(files.filter(f => f.id !== file.id))}><X size={18} /></Button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-[#f8fafc] text-gray-800">
      <header className="bg-white border-b sticky top-0 z-40">
        <div className="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
          <button onClick={() => setCurrentPage('home')} className="flex items-center gap-2">
            <div className="bg-blue-600 text-white p-1.5 rounded-lg"><Smile size={20} /></div>
            <span className="font-black text-lg">画像圧縮ツールくん</span>
          </button>
        </div>
      </header>

      <main className="max-w-5xl mx-auto px-6 py-8">
        {currentPage === 'home' && <HomeView />}
        {currentPage === 'operator' && <OperatorInfo />}
        {currentPage === 'privacy' && <PrivacyPolicy />}
        {currentPage === 'terms' && <Terms />}
      </main>

      <footer className="py-12 border-t mt-20 text-center text-sm text-gray-400 font-bold">
        <div className="flex justify-center gap-6 mb-4">
          <button onClick={() => setCurrentPage('operator')} className="hover:text-blue-600">運営者</button>
          <button onClick={() => setCurrentPage('terms')} className="hover:text-blue-600">規約</button>
          <button onClick={() => setCurrentPage('privacy')} className="hover:text-blue-600">プライバシー</button>
        </div>
        <p>© 2026 umegaoka-connect.site</p>
      </footer>
    </div>
  );
}